<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCHIPEL ‚Äî SOUVERAINET√â NUM√âRIQUE</title>
    <style>
        :root {
            --bg: #0b0e14;
            --sidebar: #13171f;
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.3);
            --secondary: #7000ff;
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --sent: linear-gradient(135deg, #00d4ff 0%, #0082ff 100%);
            --received: rgba(255, 255, 255, 0.05);
        }

        * { box-sizing: border-box; transition: all 0.2s ease-out; }
        
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-image: 
                radial-gradient(at 0% 0%, rgba(112, 0, 255, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(0, 212, 255, 0.1) 0px, transparent 50%);
        }

        /* Sidebar Style */
        .sidebar {
            width: 350px;
            background: var(--sidebar);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 10;
        }

        .logo {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -1px;
            color: var(--text);
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo span { color: var(--accent); text-shadow: 0 0 15px var(--accent-glow); }

        .search-box {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            width: 100%;
            margin-bottom: 24px;
            outline: none;
        }
        .search-box:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

        .section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-bottom: 16px;
            font-weight: 700;
        }

        .peer-list { flex: 1; overflow-y: auto; margin-bottom: 20px; }
        
        .peer-item {
            padding: 14px;
            border-radius: 16px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            border: 1px solid transparent;
            background: transparent;
        }
        .peer-item:hover { background: var(--glass); transform: translateX(4px); }
        .peer-item.active { background: rgba(0, 212, 255, 0.1); border-color: var(--accent-glow); }

        .peer-avatar {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Main Chat Area */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            padding: 20px 32px;
            background: rgba(11, 14, 20, 0.6);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 65%;
            padding: 14px 20px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.6;
            animation: slideUp 0.3s ease-out;
            position: relative;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message.sent {
            align-self: flex-end;
            background: var(--sent);
            color: #002e4d;
            font-weight: 500;
            border-bottom-right-radius: 4px;
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.2);
        }
        .message.received {
            align-self: flex-start;
            background: var(--received);
            border: 1px solid var(--glass-border);
            border-bottom-left-radius: 4px;
        }

        .chat-input-container {
            padding: 24px 32px;
            background: rgba(11, 14, 20, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .input-wrapper {
            flex: 1;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 4px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 0;
            color: white;
            outline: none;
            font-size: 15px;
        }

        /* Voice Button UI */
        #voiceBtn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        #voiceBtn.recording {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            animation: pulseRecord 1.5s infinite;
        }
        @keyframes pulseRecord { 
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); transform: scale(1); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); transform: scale(1); }
        }

        .recording-timer {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: none;
        }

        .action-btn {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .action-btn:hover { color: var(--accent); border-color: var(--accent); background: rgba(0, 212, 255, 0.05); }

        #sendBtn {
            background: var(--accent);
            color: #002e4d;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 15px var(--accent-glow);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }
        
        /* Audio Player Styling */
        audio { height: 35px; border-radius: 10px; filter: invert(100%) hue-rotate(180deg) brightness(1.5); }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="logo">üèùÔ∏è <span>ARCHIPEL</span></div>
        
        <input type="text" class="search-box" id="peerSearch" placeholder="Rechercher un pair..." onkeyup="filterPeers()">

        <div class="section-title">N≈ìuds Actifs</div>
        <div class="peer-list" id="peerList"></div>

        <div class="section-title">Transferts P2P</div>
        <div class="peer-list" id="fileList"></div>

        <div style="margin-top:auto; padding:16px; background:var(--glass); border-radius:16px; border:1px solid var(--glass-border)">
            <div style="font-size:10px; color:var(--accent); font-weight:800; margin-bottom:12px; letter-spacing:1px">CONNEXION DIRECTE IP</div>
            <div style="display:flex; gap:8px">
                <input type="text" id="manualIp" placeholder="192.168.1.XX" style="flex:1; background:rgba(0,0,0,0.2); border:1px solid var(--glass-border); border-radius:8px; padding:8px; color:white; font-size:12px">
                <button onclick="manualConnect()" style="background:var(--accent); border:none; border-radius:8px; width:36px; cursor:pointer; font-weight:bold">+</button>
            </div>
            <div id="myNodeId" style="font-size:9px; color:var(--text-dim); margin-top:12px; font-family:monospace">ID: ...</div>
        </div>
    </div>

    <div class="main">
        <div class="chat-header">
            <div>
                <div id="activePeerName" style="font-weight:700; font-size:18px">Bienvenue</div>
                <div id="encryptStatus" style="font-size:11px; color:var(--accent); font-weight:600; margin-top:2px">S√âCURIS√â PAR CHIFFREMENT ASYM√âTRIQUE</div>
            </div>
            <div style="display:flex; gap:12px">
                <button onclick="toggleMap()" class="action-btn" title="Topologie" style="width:auto; padding:0 16px; font-size:12px; font-weight:700; color:var(--accent)">üï∏Ô∏è R√âSEAU</button>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div style="margin:auto; text-align:center; max-width:400px; padding:40px; background:var(--glass); border-radius:30px; border:1px solid var(--glass-border)">
                <div style="font-size:40px; margin-bottom:20px">üîê</div>
                <h3 style="margin:0 0 10px 0">Espace Souverain</h3>
                <p style="color:var(--text-dim); font-size:14px; margin:0">S√©lectionnez un pair pour d√©marrer une communication chiffr√©e de bout-en-bout sans aucun serveur central.</p>
            </div>
        </div>

        <div class="chat-input-container">
            <input type="file" id="fileInput" style="display:none" onchange="uploadAndSend()">
            <button class="action-btn" onclick="document.getElementById('fileInput').click()" title="Document">üìé</button>
            <button class="action-btn" onclick="shareLocation()" title="Localisation">üìç</button>
            
            <div class="input-wrapper">
                <input type="text" id="messageInput" placeholder="√âcrire un message..." autocomplete="off">
            </div>

            <div style="position:relative">
                <div id="recordingTimer" class="recording-timer">00:00</div>
                <button id="voiceBtn" title="Vocal (Maintenir)" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                </button>
            </div>

            <button id="sendBtn">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>

    <!-- Overlay Carte -->
    <div id="mapOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:100; padding:40px; backdrop-filter:blur(20px);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <h2 style="margin:0; color:var(--accent)">üï∏Ô∏è MAILLAGE ARCHIPEL</h2>
            <button onclick="toggleMap()" style="background:#ef4444; color:white; border:none; padding:10px 24px; border-radius:12px; cursor:pointer; font-weight:800">FERMER</button>
        </div>
        <div id="mapContainer" style="width:100%; height:85%; background:rgba(255,255,255,0.02); border:1px solid var(--glass-border); border-radius:24px; position:relative; overflow:hidden">
            <canvas id="mapCanvas"></canvas>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentPeer = null;
        let myNodeId = "";
        let allPeers = [];

        // Elements UI
        const peerListEl = document.getElementById('peerList');
        const chatMessagesEl = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const activePeerName = document.getElementById('activePeerName');

        // Initialisation
        async function fetchStatus() {
            const res = await fetch('/api/status');
            const data = await res.json();
            myNodeId = data.nodeId;
            document.getElementById('myNodeId').innerText = `ID: ${myNodeId.slice(0, 24)}...`;
        }

        async function fetchPeers() {
            const res = await fetch('/api/peers');
            allPeers = await res.json();
            renderPeers();
        }

        async function fetchFiles() {
            const res = await fetch('/api/files');
            const files = await res.json();
            renderFiles(files);
        }

        function renderPeers() {
            const query = document.getElementById('peerSearch').value.toLowerCase();
            const filtered = allPeers.filter(p => p.nodeId.toLowerCase().includes(query) || p.ip.includes(query));

            peerListEl.innerHTML = filtered.map(p => {
                const color = getPeerColor(p.nodeId);
                const isActive = currentPeer === p.nodeId;
                return `
                <div class="peer-item ${isActive ? 'active' : ''}" onclick="selectPeer('${p.nodeId}')">
                    <div class="peer-avatar" style="background:${color}; color:white">${p.nodeId.slice(0, 1).toUpperCase()}</div>
                    <div style="flex:1">
                        <div style="font-weight:700; font-size:14px">${p.nodeId.slice(0, 12)}...</div>
                        <div style="font-size:11px; color:var(--text-dim)">${p.ip} ‚Ä¢ En ligne</div>
                    </div>
                    ${isActive ? '<div style="width:8px; height:8px; border-radius:50%; background:var(--accent)"></div>' : ''}
                </div>`;
            }).join('');
        }

        function getPeerColor(nodeId) {
            const colors = ['#00d4ff', '#7000ff', '#ff007a', '#00ff95', '#ffb800'];
            let hash = 0;
            for (let i = 0; i < nodeId.length; i++) hash += nodeId.charCodeAt(i);
            return colors[hash % colors.length];
        }

        function renderFiles(files) {
            const fileListEl = document.getElementById('fileList');
            fileListEl.innerHTML = files.map(f => {
                const isLocal = f.location === 'local';
                const url = isLocal ? `/shared/${encodeURIComponent(f.file_name)}` : `/downloads/${encodeURIComponent(f.file_name)}`;
                return `
                <div class="peer-item" style="padding:10px; cursor:default">
                    <div style="flex:1">
                        <div style="font-weight:600; font-size:12px">üìÑ ${f.file_name}</div>
                        <div style="font-size:10px; color:var(--text-dim)">${(f.file_size / 1024).toFixed(1)} KB ‚Ä¢ ${isLocal ? 'Partag√©' : 'Re√ßu'}</div>
                        <div style="display:flex; gap:6px; margin-top:8px">
                            ${f.location === 'remote' ? `<button onclick="downloadFile('${f.file_id}', '${f.fromNodeId}')" style="background:var(--accent); border:none; border-radius:4px; padding:4px 8px; font-size:10px; font-weight:700; cursor:pointer">DL</button>` : ''}
                            <button onclick="window.open('${url}', '_blank')" style="background:var(--glass); border:1px solid var(--glass-border); color:white; border-radius:4px; padding:4px 8px; font-size:10px; cursor:pointer">OUVRIR</button>
                        </div>
                        <div id="progress-${f.file_id}" style="height:3px; background:var(--accent); width:0%; margin-top:8px; display:none; border-radius:2px"></div>
                    </div>
                </div>`;
            }).join('');
        }

        async function selectPeer(nodeId) {
            currentPeer = nodeId;
            activePeerName.innerText = `Session avec ${nodeId.slice(0, 12)}...`;
            renderPeers();
            loadMessages();
        }

        async function loadMessages() {
            const res = await fetch('/api/messages');
            const messages = await res.json();
            chatMessagesEl.innerHTML = messages
                .filter(m => m.from === currentPeer || m.to === currentPeer)
                .map(m => `
                    <div class="message ${m.from === 'MOI' ? 'sent' : 'received'}">
                        ${formatMessage(m.message)}
                        <div style="font-size:9px; opacity:0.5; margin-top:6px; text-align:right">${new Date(m.timestamp).toLocaleTimeString()}</div>
                    </div>`).join('');
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        }

        function formatMessage(text) {
            // Liens & Localisation
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            let formatted = text.replace(urlRegex, (url) => `<a href="${url}" target="_blank" style="color:inherit; text-decoration:underline">${url}</a>`);

            // Audio (Vocal)
            if (text.includes('üé§ Message vocal :')) {
                const fileName = text.split(': ')[1];
                formatted = `üé§ VOCAL RECUTE <br><br>
                    <div style="background:rgba(0,0,0,0.15); padding:10px; border-radius:12px; display:flex; gap:10px; align-items:center">
                        <button onclick="downloadAndPlay('${fileName}')" style="background:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer">‚ñ∂</button>
                        <div style="font-size:12px; font-weight:600">Audio ‚Ä¢ Click pour lire</div>
                    </div>`;
            }
            
            // Fichiers P2P
            if (text.includes('üì¶ Fichier disponible')) {
                const parts = text.split(' : ');
                const fileName = parts[1].split(' (')[0];
                formatted = `üì¶ DOCUMENT PARTAG√â : <br><b>${fileName}</b><br>
                    <button onclick="downloadFileByName('${fileName}')" style="margin-top:10px; background:rgba(255,255,255,0.2); border:none; padding:6px 12px; border-radius:8px; color:white; font-size:11px; cursor:pointer; font-weight:700">T√âL√âCHARGER</button>`;
            }

            return formatted;
        }

        // Logic Recording (CORRIG√âE & ROBUSTE)
        let mediaRecorder;
        let audioChunks = [];
        let recordInterval;
        let startTime;

        async function startRecording() {
            if (!currentPeer) return alert("S√©lectionnez un destinataire");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                audioChunks = [];
                
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = async () => {
                        const base64data = reader.result.split(',')[1];
                        await fetch('/api/voice', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ targetNodeId: currentPeer, audioData: base64data })
                        });
                    };
                    stream.getTracks().forEach(track => track.stop()); // Lib√®re le micro
                };

                mediaRecorder.start(1000); // Enregistre par tranches de 1s
                startTime = Date.now();
                document.getElementById('voiceBtn').classList.add('recording');
                document.getElementById('recordingTimer').style.display = 'block';
                
                recordInterval = setInterval(() => {
                    const diff = Math.floor((Date.now() - startTime) / 1000);
                    const m = Math.floor(diff / 60).toString().padStart(2, '0');
                    const s = (diff % 60).toString().padStart(2, '0');
                    document.getElementById('recordingTimer').innerText = `${m}:${s}`;
                }, 1000);
            } catch (e) { alert("Acc√®s micro refus√©"); }
        }

        function stopRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') return;
            mediaRecorder.stop();
            clearInterval(recordInterval);
            document.getElementById('voiceBtn').classList.remove('recording');
            document.getElementById('recordingTimer').style.display = 'none';
        }

        // Fonctions de Transfert
        async function downloadFile(fileId, fromNodeId) {
            document.getElementById(`progress-${fileId}`).style.display = 'block';
            await fetch('/api/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileId, fromNodeId })
            });
        }

        async function downloadAndPlay(fileName) {
            const res = await fetch('/api/files');
            const files = await res.json();
            const local = files.find(f => f.file_name === fileName && f.location === 'local');
            if (local) return playAudio(`/shared/${fileName}`);

            const remote = files.find(f => f.file_name === fileName && f.location === 'remote');
            if (remote) {
                window._playAfterDl = fileName;
                await downloadFile(remote.file_id, remote.fromNodeId);
            } else {
                playAudio(`/downloads/${fileName}`);
            }
        }

        function playAudio(url) {
            new Audio(url).play().catch(() => alert("Cliquer sur la page pour autoriser le son"));
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentPeer) return;
            messageInput.value = '';
            await fetch('/api/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nodeId: currentPeer, message: text })
            });
        }

        async function manualConnect() {
            const ip = document.getElementById('manualIp').value;
            if (ip) await fetch('/api/connect', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ip }) });
            alert("Requ√™te de connexion envoy√©e √† " + ip);
        }

        // Socket Events
        socket.on('new_message', (msg) => {
            if (msg.from === currentPeer || msg.to === currentPeer) {
                const el = document.createElement('div');
                el.className = `message ${msg.from === 'MOI' ? 'sent' : 'received'}`;
                el.innerHTML = `${formatMessage(msg.message)}<div style="font-size:9px; opacity:0.5; margin-top:6px; text-align:right">${new Date(msg.timestamp).toLocaleTimeString()}</div>`;
                chatMessagesEl.appendChild(el);
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
                
                // Auto-DL Vocaux
                if (msg.from !== 'MOI' && msg.message.includes('üé§ Message vocal :')) {
                    const fileName = msg.message.split(': ')[1];
                    window._playAfterDl = fileName;
                    downloadAndPlay(fileName);
                }
            }
        });

        socket.on('download_complete', (data) => {
            if (window._playAfterDl === data.fileName) {
                playAudio(`/downloads/${data.fileName}`);
                window._playAfterDl = null;
            }
            fetchFiles();
        });

        socket.on('download_progress', (data) => {
            const bar = document.getElementById(`progress-${data.fileId}`);
            if (bar) { bar.style.display = 'block'; bar.style.width = `${(data.downloaded / data.total) * 100}%`; }
        });

        socket.on('new_peer', () => { fetchPeers(); fetchFiles(); });

        // Event Listeners
        sendBtn.onclick = sendMessage;
        messageInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };

        // Topologie Map
        function toggleMap() {
            const overlay = document.getElementById('mapOverlay');
            overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none';
            if (overlay.style.display === 'block') drawMap();
        }

        function drawMap() {
            const canvas = document.getElementById('mapCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            // Moi
            ctx.fillStyle = "#00d4ff";
            ctx.shadowBlur = 20; ctx.shadowColor = "#00d4ff";
            ctx.beginPath(); ctx.arc(centerX, centerY, 15, 0, Math.PI * 2); ctx.fill();
            ctx.shadowBlur = 0; ctx.fillStyle = "white"; ctx.fillText("MOI (LOCAL)", centerX - 30, centerY + 35);

            // Pairs
            const radius = 180;
            allPeers.forEach((p, i) => {
                const angle = (i / allPeers.length) * Math.PI * 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;

                ctx.strokeStyle = "rgba(0, 212, 255, 0.2)";
                ctx.beginPath(); ctx.moveTo(centerX, centerY); ctx.lineTo(x, y); ctx.stroke();

                ctx.fillStyle = getPeerColor(p.nodeId);
                ctx.shadowBlur = 15; ctx.shadowColor = ctx.fillStyle;
                ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0; ctx.fillStyle = "white"; ctx.fillText(p.nodeId.slice(0, 8), x - 20, y + 25);
            });
        }

        // Init
        fetchStatus(); fetchPeers(); fetchFiles();
        setInterval(() => { fetchPeers(); fetchFiles(); }, 5000);
    </script>
</body>
</html>
